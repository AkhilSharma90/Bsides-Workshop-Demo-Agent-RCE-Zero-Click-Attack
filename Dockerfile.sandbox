# Dockerfile for sandboxed command execution
# Provides isolated environment with fake kubectl/aws/ssh tools
# Used for realistic RCE demonstration without actual danger

FROM alpine:3.18

# Install basic utilities
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    python3 \
    && rm -rf /var/cache/apk/*

# Create fake kubectl command
RUN cat > /usr/local/bin/kubectl <<'EOF' && chmod +x /usr/local/bin/kubectl
#!/bin/bash

# Fake kubectl that returns realistic outputs

if [[ "$*" == *"get pods"* ]] || [[ "$*" == *"get pod"* ]]; then
    echo "NAME              READY   STATUS    RESTARTS   AGE"
    echo "api-server-7d8f9c4b   1/1     Running   0          5d"
    echo "worker-5c3a1e8d       1/1     Running   0          3d"
    echo "redis-cache-9f2b4a    1/1     Running   0          7d"
elif [[ "$*" == *"exec"* ]]; then
    echo "root@api-server-7d8f9c4b:/app# whoami"
    echo "root"
    echo "root@api-server-7d8f9c4b:/app# hostname"
    echo "api-server-7d8f9c4b"
    echo "root@api-server-7d8f9c4b:/app# ls -la /"
    echo "total 84"
    echo "drwxr-xr-x   1 root root 4096 Jan 28 10:15 ."
    echo "drwxr-xr-x   1 root root 4096 Jan 28 10:15 .."
    echo "drwxr-xr-x   2 root root 4096 Dec 15 08:23 app"
    echo "drwxr-xr-x   2 root root 4096 Dec 15 08:23 bin"
elif [[ "$*" == *"describe"* ]]; then
    echo "Name:         api-server-7d8f9c4b"
    echo "Namespace:    production"
    echo "Priority:     0"
    echo "Node:         node-3a7f9d/10.0.1.45"
    echo "Status:       Running"
    echo "IP:           10.244.2.15"
    echo "Containers:"
    echo "  main:"
    echo "    Image:          api-server:v1.2.3"
    echo "    State:          Running"
    echo "    Ready:          True"
elif [[ "$*" == *"logs"* ]]; then
    echo "2025-01-28T10:15:35Z INFO Starting API server on port 8080"
    echo "2025-01-28T10:15:36Z INFO Connected to database postgres-db:5432"
    echo "2025-01-28T10:15:36Z INFO Connected to Redis redis-cache:6379"
    echo "2025-01-28T10:16:42Z INFO GET /api/users 200 45ms"
    echo "2025-01-28T10:17:15Z INFO POST /api/orders 201 123ms"
else
    echo "kubectl command executed: $*"
    echo "Cluster: production-cluster"
    echo "Context: prod-admin"
fi
EOF

# Create fake aws CLI
RUN cat > /usr/local/bin/aws <<'EOF' && chmod +x /usr/local/bin/aws
#!/bin/bash

# Fake AWS CLI that returns realistic outputs

if [[ "$*" == *"s3 ls"* ]]; then
    echo "2025-01-28 06:00:00   10.00 MB backups/2025-01-28.tar.gz"
    echo "2025-01-27 06:00:00    9.75 MB backups/2025-01-27.tar.gz"
    echo "2025-01-20 14:30:00    0.00 MB configs/prod.json"
    echo "2025-01-28 10:00:00    0.50 MB logs/app-2025-01-28.log"
elif [[ "$*" == *"ec2 describe-instances"* ]]; then
    echo "INSTANCES	i-0a1b2c3d4e5f6g7h8	t3.large	running	10.0.1.45	54.123.45.67"
    echo "TAGS	Name	api-server-prod-1"
    echo "TAGS	Environment	production"
elif [[ "$*" == *"ssm start-session"* ]]; then
    echo "Starting session with SessionId: admin-0123456789abcdef0"
    echo "sh-4.2$ whoami"
    echo "ssm-user"
    echo "sh-4.2$ hostname"
    echo "ip-10-0-1-45.ec2.internal"
elif [[ "$*" == *"secretsmanager"* ]] || [[ "$*" == *"secrets"* ]]; then
    echo '{"ARN":"arn:aws:secretsmanager:us-east-1:123456789012:secret:prod/db","SecretString":"{\\"username\\":\\"admin\\",\\"password\\":\\"REDACTED\\",\\"host\\":\\"prod-db.rds.amazonaws.com\\"}"}'
else
    echo "AWS CLI command executed: $*"
    echo "Region: us-east-1"
    echo "Account: 123456789012"
fi
EOF

# Create fake ssh
RUN cat > /usr/local/bin/ssh <<'EOF' && chmod +x /usr/local/bin/ssh
#!/bin/bash

echo "Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-88-generic x86_64)"
echo ""
echo "Last login: Tue Jan 28 10:15:32 2025 from 192.168.1.100"
echo ""
echo "admin@prod-server-01:~$ whoami"
echo "admin"
echo "admin@prod-server-01:~$ hostname"
echo "prod-server-01"
echo "admin@prod-server-01:~$ uname -a"
echo "Linux prod-server-01 5.15.0-88-generic #98-Ubuntu SMP x86_64 GNU/Linux"
EOF

# Create a safe command executor script
RUN cat > /usr/local/bin/safe-exec <<'EOF' && chmod +x /usr/local/bin/safe-exec
#!/bin/bash

# Safe command executor - only allows allowlisted commands
# Used by sandbox.py for controlled execution

COMMAND="$1"

# Allowlist of permitted commands
case "$COMMAND" in
    kubectl*)
        /usr/local/bin/kubectl ${COMMAND#kubectl }
        ;;
    aws*)
        /usr/local/bin/aws ${COMMAND#aws }
        ;;
    ssh*)
        /usr/local/bin/ssh ${COMMAND#ssh }
        ;;
    curl*)
        # Parse curl URL
        URL=$(echo "$COMMAND" | grep -oP 'https?://[^\s]+' || echo "https://api.internal.company.com/health")
        echo '{"status":"healthy","version":"1.2.3","uptime":864723,"services":{"database":"connected","redis":"connected"}}'
        ;;
    whoami)
        echo "demo-user"
        ;;
    hostname)
        echo "sandbox-container"
        ;;
    pwd)
        echo "/workspace"
        ;;
    *)
        echo "Command not in allowlist: $COMMAND"
        echo "Permitted commands: kubectl, aws, ssh, curl, whoami, hostname, pwd"
        exit 1
        ;;
esac
EOF

# Create workspace directory
RUN mkdir /workspace

# Set non-root user for safety
RUN adduser -D -u 1000 sandboxuser
USER sandboxuser

WORKDIR /workspace

# Default command
CMD ["/bin/bash"]
